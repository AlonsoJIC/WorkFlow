<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h3">Guardar Matrícula</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
      <div class="btn-group me-2">
          <a class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1" routerLink="/dashboard/matriculas">
              <i class="bi bi-backspace"></i>
              Regresar
          </a>
      </div>
  </div>
</div>

<div class="card">
  <div class="card-header">Complete todos los campos requeridos</div>
  <div class="card-body">
      @defer {
      <form [formGroup]="formulario" (ngSubmit)="Guardar()">
          <div class="row">
              <div class="col-md-8">
                  <div class="col-md-12">
                      <input type="text" placeholder="Digite el curso a buscar..." class="form-control"
                          [formControl]="curso" [matAutocomplete]="autoCurso">
                      <mat-autocomplete #autoCurso="matAutocomplete" [displayWith]="MostrarCurso">
                          @for (obCurso of CursosFiltrados | async; track $index) {
                          <mat-option [value]="obCurso">
                              {{obCurso.nombre}}
                          </mat-option>
                          }
                      </mat-autocomplete>
                  </div>

                  <div class="col-md-12 mt-4">
                      <div class="table-responsive">
                          <table class="table table-striped table-bordered">
                              <thead class="text-center">
                                  <tr>
                                      <th width="4%"></th>
                                      <th>Curso <span class="text-danger">*</span></th>
                                  </tr>
                              </thead>
                              <tbody>
                                  @if (arrCursos.length == 0) {
                                  <tr>
                                      <td colspan="2" class="text-center">-- Sin cursos --</td>
                                  </tr>
                                  }

                                  @for (linea of arrCursos; track $index) {
                                  <tr>
                                      <td>
                                          <button type="button" class="btn btn-sm btn-outline-danger"
                                              (click)="EliminarCurso(linea.curso.idCurso)">
                                              <i class="bi bi-trash text-danger"></i>
                                          </button>
                                      </td>
                                      <td class="text-center">
                                          {{linea.curso.nombre}}
                                      </td>
                                  </tr>
                                  }
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>

              <div class="col-md-4">
                  <table class="table table-striped table-bordered">
                      <tbody>
                          <tr>
                              <td colspan="2" class="text-center">Información general</td>
                          </tr>
                          <tr>
                              <td>Código: <span class="text-danger">*</span></td>
                              <td>
                                  <input type="text"
                                      placeholder="Ingrese el código..." formControlName="codigo"
                                      class="form-control mb-2">
                                  @if (codigo.errors && (codigo.dirty || codigo.touched)) {
                                      <span class="text-danger mb-2">El código es requerido.</span>
                                  }
                              </td>
                          </tr>
                          <tr>
                              <td>Oferta: <span class="text-danger">*</span></td>
                              <td>
                                  <select class="form-select mb-2" aria-label="Seleccione la oferta"
                                      formControlName="oferta">
                                      <option value="" selected>Seleccione la oferta</option>
                                      @for (oferta of ofertas; track $index) {
                                          <option value="{{oferta.idOferta}}">{{oferta.codigo}}</option>
                                      }
                                  </select>
                                  @if (oferta.errors && (oferta.dirty || oferta.touched)) {
                                      <span class="text-danger mb-2">La oferta es requerida.</span>
                                  }
                              </td>
                          </tr>
                          <tr>
                              <td colspan="2" class="text-center">Estudiante <span class="text-danger">*</span></td>
                          </tr>
                          <tr>
                              <td colspan="2">
                                  <input type="text" placeholder="Ingrese el estudiante..." class="form-control mb-2"
                                      [matAutocomplete]="autoEstudiante" [formControl]="estudiante">
                                  <mat-autocomplete #autoEstudiante="matAutocomplete"
                                      [displayWith]="MostrarEstudiante">
                                      @for (obEstudiante of EstudiantesFiltrados | async; track $index) {
                                      <mat-option [value]="obEstudiante">
                                          {{obEstudiante.nombre}} {{obEstudiante.apellidos}}
                                      </mat-option>
                                      }
                                  </mat-autocomplete>
                              </td>
                          </tr>
                          @if (tmpEstudiante != null) {
                          <tr>
                              <td colspan="2" class="text-center text-primary">Información del Estudiante</td>
                          </tr>
                          <tr>
                              <td>Identificación:</td>
                              <td>{{tmpEstudiante.identificacion}}</td>
                          </tr>
                          <tr>
                              <td>Nombre:</td>
                              <td>{{tmpEstudiante.nombre}} {{tmpEstudiante.apellidos}}</td>
                          </tr>
                          <tr>
                              <td>Correo:</td>
                              <td>{{tmpEstudiante.correo}}</td>
                          </tr>
                          <tr>
                              <td>Teléfono:</td>
                              <td>{{tmpEstudiante.telefono}}</td>
                          </tr>
                          <tr>
                              <td colspan="2" class="text-center">
                                  <a title="Editar estudiante" class="btn btn-outline-success"
                                      [routerLink]="['/estudiantes/actualizar/', tmpEstudiante.idEstudiante]">
                                      <i class="bi bi-pencil-square"></i> Actualizar Información
                                  </a>
                              </td>
                          </tr>
                          }
                      </tbody>
                  </table>
              </div>
              
              <div class="col-md-12 mt-2">
                  <hr>
                  <div class="mb-3">
                      <label class="form-label">Descripción: <span class="text-secondary">(Opcional)</span></label>
                      <textarea formControlName="descripcion" rows="4" placeholder="Ingrese una descripcion..."
                          class="form-control"></textarea>
                  </div>
                  <hr>
                  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                      <button class="btn btn-outline-primary me-md-2" type="submit" [disabled]="!formulario.valid">
                          @if (cargando) {
                          <i class="bi bi-hourglass-split"></i> Guardando...
                          } @else {
                          <i class="bi bi-plus-circle"></i> Guardar
                          }
                      </button>
                      <button class="btn btn-outline-secondary" type="reset">
                          <i class="bi bi-x-circle"></i>
                          Limpiar
                      </button>
                  </div>
              </div>
          </div>
      </form>
      } @loading {
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      }
  </div>
</div>